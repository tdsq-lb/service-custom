import{j as e,m as s,s as t,C as o,k as i,l,p as r,q as n,u as c,v as a,x as d,y as h,z as u,A as m,B as g,c as p,w as f,i as I,o as _,a as b,d as U,t as T,e as k,b as y,r as C,F as S,D as x,E as w,G as E,H,f as R,S as B,I as O,J as A,K as j,g as F}from"./index-CTiNpAnj.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";const L=""+new URL("back-B5TLr74X.png",import.meta.url).href,v=""+new URL("emote-tbvoNmmN.png",import.meta.url).href,V=""+new URL("add-CYsjhQDM.png",import.meta.url).href,N=""+new URL("img-D0HOJJRR.png",import.meta.url).href;const D=$({data:()=>({title:null,custUserId:null,scrollViewHeight:0,scrollTop:0,emoteArr:e,content:"",isFocus:!1,isEmote:!1,isAdd:!1,uploading:!1,uploadSuccess:!1,uploadError:!1,item:""}),computed:{...s({userInfo:e=>e.userInfo,isRegister:e=>e.isRegister,chatHistoryList:e=>e.chatHistoryList,closeUserObj:e=>e.closeUserObj,pagingObj:e=>e.pagingObj,triggered:e=>e.triggered}),getScrollViewHeight:function(){return this.scrollViewHeight}},watch:{chatHistoryList(e){console.log("chatHistoryList::newVal",e),this.$nextTick((()=>{this.item="item-"+(e.length-1),console.log(this.item,"2222222item"),this.scrollToBottom()}))},deep:!0,immediate:!0},onLoad(e){console.log(e.custUserId,"options"),this.userInfo&&1==this.userInfo.isCustomerService&&e.custUserId&&(this.getHistoryMsg(e.custUserId),this.title=e.sendName,this.custUserId=e.custUserId)},mounted(){console.log("mounted::this.userInfo",this.userInfo),this.userInfo&&1==this.userInfo.isCustomerService&&this.custUserId&&(o.d.userId=this.custUserId,t(o)),this.$nextTick((()=>{this.updateHeight()}))},onUnload(){this.userInfo&&1==this.userInfo.isCustomerService&&this.custUserId&&(o.d.userId=this.custUserId,t(o)),this.userInfo&&0==this.userInfo.isCustomerService&&(o.d.userId=this.closeUserObj&&this.closeUserObj.csUserId||0,t(o))},updated(){},methods:{goBack(){i(),this.$store.commit("SET_CHAT_HISTORY_LIST",{type:"clear"}),this.$store.commit("SET_PAGING_OBG",{pageNum:1,refresherEnabled:!0})},updateHeight(){const e=l().screenHeight;let s=0;this.$nextTick((()=>{if(console.log("this.$refs.fixedView",this.$refs.fixedView),this.$refs.fixedView){r().in(this).select(".box-2").boundingClientRect((e=>{console.log("box-2 固定定位元素的高度:",e.height),s=e.height+100})).exec()}this.$set(this,"scrollViewHeight",e-s),console.log("scrollViewHeight",this.scrollViewHeight)}))},onRefresh(){console.log("加载更多数据..."),this.getHistoryMsg()},getHistoryMsg(e){console.log("getHistoryMsg"),this.$store.commit("SET_TRIGGERD",!0),e&&(c.d.custUserId=e),this.chatHistoryList&&this.chatHistoryList.length>0?c.d.sendTime=this.chatHistoryList[0].sendTime:c.d.sendTime=null,c.d.requestId=n(),c.d.pageNum=this.pagingObj.pageNum,t(c)},scrollToBottom(){r().in(this).select(".box-1").boundingClientRect((e=>{console.log("box-1的高度:",e.height),this.$set(this,"scrollTop",e.height)})).exec()},getHttpImagedUrl:e=>`${window.IMAGE_BASEURL}${e}`,previewImage(e){a({current:0,urls:[this.getHttpImagedUrl(e)]})},handleEmote(e){this.content+=e},send(){this.content?(h({title:"正在发送"}),this.handleSendCS4002(1)):d({title:"请输入有效的内容",icon:"none"})},handleInputFocus(){this.isFocus=!0,this.isEmote=!1,this.isAdd=!1},handleInputBlur(){setTimeout((()=>{this.isFocus=!1,this.isEmote=!1,this.isAdd=!1}),0)},handleBtnEmote(){setTimeout((()=>{this.isFocus=!1,this.isEmote=!0,this.isAdd=!1}),10)},handleBtnAdd(){setTimeout((()=>{this.isFocus=!1,this.isEmote=!1,this.isAdd=!0}),10)},handleSendCS4002(e,s){h({title:"正在发送"}),console.log("this.closeUserObj",this.closeUserObj),1==this.userInfo.isCustomerService?u.u=this.custUserId:u.u=this.closeUserObj&&this.closeUserObj.csUserId,u.d={requestId:n(),type:1,sendTime:(new Date).getTime(),logo:this.userInfo.logo},1==e&&(u.d.msgType=1,u.d.message=this.content),3==e&&(u.d.msgType=3,u.d.message=s.data),this.$store.commit("SET_NEWS_OBJ",u.d),this.$store.commit("SET_IS_REGISTER",!1),t(u),this.$nextTick((()=>{this.content="",this.scrollToBottom()}))},chooseImage(){m({count:1,success:e=>{const s=e.tempFilePaths[0];s.size>5242880?d({title:"图片大小不能超过 5MB",icon:"none"}):(this.imageUrl=s,this.uploadImage(s))},fail:e=>{console.log("选择图片失败",e)}})},uploadImage(e){this.uploading=!0,g({url:`${window.API_BASEURL}/app/uploadFile`,filePath:e,name:"file",formData:{type:"chat"},header:{Authorization:this.userInfo.Authorization,ContentType:"multipart/form-data"},success:e=>{this.uploading=!1,this.uploadSuccess=!0;const s=JSON.parse(e.data);console.log(s,"result"),0==s.code?(console.log("上传成功"),this.handleSendCS4002(3,JSON.parse(e.data))):(console.log("上传失败"),d({title:s.message,icon:"error",duration:2e3})),this.handleInputBlur()},fail:e=>{this.uploading=!1,this.uploadError=!0,console.log("上传失败",e)}})}}},[["render",function(e,s,t,o,i,l){const r=R,n=I,c=F,a=B,d=O,h=A;return _(),p(n,{class:"container"},{default:f((()=>[e.userInfo&&1==e.userInfo.isCustomerService?(_(),p(n,{key:0,class:"go_back"},{default:f((()=>[b(r,{src:L,mode:"aspectFill",class:"back",onClick:l.goBack},null,8,["onClick"]),b(n,{class:"title"},{default:f((()=>[U(T(i.title),1)])),_:1}),b(n,{class:"back"})])),_:1})):k("",!0),b(a,{"scroll-y":"",ref:"scrollView","refresher-enabled":e.pagingObj.refresherEnabled,"refresher-triggered":e.triggered,"refresher-background":"#f3f3f3",onRefresherrefresh:l.onRefresh,onClick:l.handleInputBlur,"scroll-with-animation":"","scroll-into-view":i.item,"scroll-top":i.scrollTop,style:x({height:i.scrollViewHeight+"px",paddingTop:e.userInfo&&1==e.userInfo.isCustomerService?"40px":"0"})},{default:f((()=>[b(n,{class:"box-1",id:"list-box"},{default:f((()=>[b(n,{class:"talk-list"},{default:f((()=>[(_(!0),y(S,null,C(e.chatHistoryList,((e,s)=>(_(),p(n,{key:s,id:`msg-${e.requestId}`},{default:f((()=>[b(n,{class:j(["item flex_col",1==e.type?"push":"pull"])},{default:f((()=>[b(r,{src:l.getHttpImagedUrl(e.logo),mode:"aspectFill",class:"pic"},null,8,["src"]),b(n,{class:"content"},{default:f((()=>[1==e.msgType?(_(),p(c,{key:0},{default:f((()=>[U(T(e.message),1)])),_:2},1024)):k("",!0),3==e.msgType?(_(),p(r,{key:1,class:"image_box",src:l.getHttpImagedUrl(e.message),mode:"aspectFill",onClick:s=>l.previewImage(e.message)},null,8,["src","onClick"])):k("",!0)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1032,["id"])))),128))])),_:1})])),_:1})])),_:1},8,["refresher-enabled","refresher-triggered","onRefresherrefresh","onClick","scroll-into-view","scroll-top","style"]),e.isRegister||e.userInfo&&0==e.userInfo.isCustomerService&&e.closeUserObj&&e.closeUserObj.csUserId&&e.closeUserObj.custUserId?(_(),p(n,{key:1,ref:"fixedView",class:"box-2"},{default:f((()=>[b(n,{class:"flex_col"},{default:f((()=>[b(n,{class:"flex_grow"},{default:f((()=>[b(d,{type:"text",class:"content",modelValue:i.content,"onUpdate:modelValue":s[0]||(s[0]=e=>i.content=e),placeholder:"请输入","placeholder-style":"color:#DDD;","cursor-spacing":6,onFocus:s[1]||(s[1]=e=>l.handleInputFocus()),onBlur:s[2]||(s[2]=e=>l.handleInputBlur()),onConfirm:s[3]||(s[3]=e=>l.send())},null,8,["modelValue"])])),_:1}),b(r,{class:"btn_icon",src:v,onClick:s[4]||(s[4]=e=>l.handleBtnEmote())}),w(b(r,{class:"btn_icon",src:V,onClick:s[5]||(s[5]=e=>l.handleBtnAdd())},null,512),[[E,!i.isFocus&&!i.isEmote]]),w(b(h,{class:"send",onClick:l.send},{default:f((()=>[U("发送")])),_:1},8,["onClick"]),[[E,i.isFocus||i.isEmote]])])),_:1}),w(b(n,{class:"emote_box"},{default:f((()=>[(_(!0),y(S,null,C(i.emoteArr,(e=>(_(),p(n,{class:"emote_box_item",key:e,onClick:s=>l.handleEmote(e)},{default:f((()=>[U(T(e),1)])),_:2},1032,["onClick"])))),128))])),_:1},512),[[E,!i.isFocus&&!i.isAdd&&i.isEmote]]),w(b(n,{class:"more_box"},{default:f((()=>[b(r,{onClick:H(l.chooseImage,["stop"]),src:N},null,8,["onClick"])])),_:1},512),[[E,!i.isFocus&&!i.isEmote&&i.isAdd]])])),_:1},512)):k("",!0)])),_:1})}],["__scopeId","data-v-47d869ed"]]);export{D as default};
