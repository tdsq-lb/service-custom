import{j as e,m as s,k as t,l as o,p as i,q as l,s as r,C as a,u as c,v as n,x as d,y as h,z as u,A as g,c as m,w as p,i as f,o as I,a as _,d as T,t as b,e as k,b as x,r as H,F as y,B as U,D as E,E as C,G as S,f as B,S as w,I as R,H as A,J as $,g as F}from"./index-BNSODplq.js";import{_ as O}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=""+new URL("back-B5TLr74X.png",import.meta.url).href,L=""+new URL("emote-tbvoNmmN.png",import.meta.url).href,V=""+new URL("add-CYsjhQDM.png",import.meta.url).href,v=""+new URL("img-D0HOJJRR.png",import.meta.url).href;const N=O({data:()=>({title:null,custUserId:null,scrollViewHeight:0,scrollTop:0,emoteArr:e,content:"",isFocus:!1,isEmote:!1,isAdd:!1,uploading:!1,uploadSuccess:!1,uploadError:!1}),computed:{...s({userInfo:e=>e.userInfo,isRegister:e=>e.isRegister,chatHistoryList:e=>e.chatHistoryList,closeUserObj:e=>e.closeUserObj,pagingObj:e=>e.pagingObj,triggered:e=>e.triggered}),getScrollViewHeight:function(){return this.scrollViewHeight}},onLoad(e){console.log(e.custUserId,"options"),this.userInfo&&1==this.userInfo.isCustomerService&&e.custUserId&&(this.getHistoryMsg(e.custUserId),this.title=e.sendName,this.custUserId=e.custUserId)},mounted(){this.updateHeight()},updated(){},methods:{goBack(){t(),this.$store.commit("SET_CHAT_HISTORY_LIST",{type:"clear"}),this.$store.commit("SET_PAGING_OBG",{pageNum:1,refresherEnabled:!0})},updateHeight(){const e=o().screenHeight;let s=0;this.$nextTick((()=>{if(console.log("this.$refs.fixedView",this.$refs.fixedView),this.$refs.fixedView){i().in(this).select(".box-2").boundingClientRect((e=>{console.log("box-2 固定定位元素的高度:",e.height),s=e.height+40})).exec()}this.userInfo&&1==this.userInfo.isCustomerService&&(s+=40),this.scrollToBottom(),this.$set(this,"scrollViewHeight",e-s),console.log("scrollViewHeight",this.scrollViewHeight)})),this.scrollToBottom()},onRefresh(){console.log("加载更多数据..."),this.getHistoryMsg()},getHistoryMsg(e){console.log("getHistoryMsg"),this.$store.commit("SET_TRIGGERD",!0),e&&(a.d.custUserId=e),this.chatHistoryList&&this.chatHistoryList.length>0?a.d.sendTime=this.chatHistoryList[0].sendTime:a.d.sendTime="",a.d.requestId=l(),a.d.pageNum=this.pagingObj.pageNum,r(a)},scrollToBottom(){i().in(this).select(".box-1").boundingClientRect((e=>{console.log("box-1的高度:",e.height),this.$set(this,"scrollTop",e.height)})).exec()},getHttpImagedUrl:e=>`${window.IMAGE_BASEURL}${e}`,previewImage(e){c({current:0,urls:[this.getHttpImagedUrl(e)]})},handleEmote(e){this.content+=e},send(){this.content?(d({title:"正在发送"}),this.handleSendCS4002(1)):n({title:"请输入有效的内容",icon:"none"})},handleInputFocus(){this.isFocus=!0,this.isEmote=!1,this.isAdd=!1,this.updateHeight(),this.$nextTick((()=>{this.scrollToBottom()}))},handleInputBlur(){setTimeout((()=>{this.isFocus=!1,this.isEmote=!1,this.isAdd=!1,this.updateHeight()}),0),this.$nextTick((()=>{this.scrollToBottom()}))},handleBtnEmote(){setTimeout((()=>{this.isFocus=!1,this.isEmote=!0,this.isAdd=!1,this.updateHeight()}),10),this.$nextTick((()=>{this.scrollToBottom()}))},handleBtnAdd(){setTimeout((()=>{this.isFocus=!1,this.isEmote=!1,this.isAdd=!0,this.updateHeight(),this.scrollToBottom()}),10),this.$nextTick((()=>{}))},handleSendCS4002(e,s){d({title:"正在发送"}),h.u=this.closeUserObj&&this.closeUserObj.csUserId||this.custUserId,h.d={requestId:l(),type:1,sendTime:(new Date).getTime(),logo:this.userInfo.logo},1==e&&(h.d.msgType=1,h.d.message=this.content),console.log("imgUrl,",s),3==e&&(h.d.msgType=3,h.d.message=s.data),this.$store.commit("SET_NEWS_OBJ",h.d),this.$store.commit("SET_IS_REGISTER",!1),r(h),this.$nextTick((()=>{this.content="",this.scrollToBottom()}))},chooseImage(){u({count:1,success:e=>{const s=e.tempFilePaths[0];s.size>5242880?n({title:"图片大小不能超过 5MB",icon:"none"}):(this.imageUrl=s,this.uploadImage(s))},fail:e=>{console.log("选择图片失败",e)}})},uploadImage(e){this.uploading=!0,g({url:`${window.API_BASEURL}/app/uploadFile`,filePath:e,name:"file",formData:{type:"chat"},header:{Authorization:this.userInfo.Authorization,ContentType:"multipart/form-data"},success:e=>{this.uploading=!1,this.uploadSuccess=!0;const s=JSON.parse(e.data);console.log(s,"result"),0==s.code?(console.log("上传成功"),this.handleSendCS4002(3,JSON.parse(e.data))):(console.log("上传失败"),n({title:s.message,icon:"error",duration:2e3})),this.handleInputBlur()},fail:e=>{this.uploading=!1,this.uploadError=!0,console.log("上传失败",e)}})}}},[["render",function(e,s,t,o,i,l){const r=B,a=f,c=F,n=w,d=R,h=A;return I(),m(a,{class:"container"},{default:p((()=>[e.userInfo&&1==e.userInfo.isCustomerService?(I(),m(a,{key:0,class:"go_back"},{default:p((()=>[_(r,{src:j,mode:"aspectFill",class:"back",onClick:l.goBack},null,8,["onClick"]),_(a,{class:"title"},{default:p((()=>[T(b(i.title),1)])),_:1}),_(a,{class:"back"})])),_:1})):k("",!0),_(n,{"scroll-y":"",ref:"scrollView","refresher-enabled":e.pagingObj.refresherEnabled,"refresher-triggered":e.triggered,"refresher-background":"#f3f3f3",onRefresherrefresh:l.onRefresh,onClick:l.handleInputBlur,"scroll-top":i.scrollTop,style:U({height:i.scrollViewHeight+"px",paddingTop:e.userInfo&&1==e.userInfo.isCustomerService?"40px":"0"})},{default:p((()=>[_(a,{class:"box-1",id:"list-box"},{default:p((()=>[_(a,{class:"talk-list"},{default:p((()=>[(I(!0),x(y,null,H(e.chatHistoryList,((e,s)=>(I(),m(a,{key:s,id:`msg-${e.requestId}`},{default:p((()=>[_(a,{class:$(["item flex_col",1==e.type?"push":"pull"])},{default:p((()=>[_(r,{src:l.getHttpImagedUrl(e.logo),mode:"aspectFill",class:"pic"},null,8,["src"]),_(a,{class:"content"},{default:p((()=>[1==e.msgType?(I(),m(c,{key:0},{default:p((()=>[T(b(e.message),1)])),_:2},1024)):k("",!0),3==e.msgType?(I(),m(r,{key:1,class:"image_box",src:l.getHttpImagedUrl(e.message),mode:"aspectFill",onClick:s=>l.previewImage(e.message)},null,8,["src","onClick"])):k("",!0)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1032,["id"])))),128))])),_:1})])),_:1})])),_:1},8,["refresher-enabled","refresher-triggered","onRefresherrefresh","onClick","scroll-top","style"]),e.isRegister||e.userInfo&&0==e.userInfo.isCustomerService&&e.closeUserObj&&e.closeUserObj.csUserId&&e.closeUserObj.custUserId?(I(),m(a,{key:1,ref:"fixedView",class:"box-2"},{default:p((()=>[_(a,{class:"flex_col"},{default:p((()=>[_(a,{class:"flex_grow"},{default:p((()=>[_(d,{type:"text",class:"content",modelValue:i.content,"onUpdate:modelValue":s[0]||(s[0]=e=>i.content=e),placeholder:"请输入","placeholder-style":"color:#DDD;","cursor-spacing":6,onFocus:s[1]||(s[1]=e=>l.handleInputFocus()),onBlur:s[2]||(s[2]=e=>l.handleInputBlur()),onConfirm:s[3]||(s[3]=e=>l.send())},null,8,["modelValue"])])),_:1}),_(r,{class:"btn_icon",src:L,onClick:s[4]||(s[4]=e=>l.handleBtnEmote())}),E(_(r,{class:"btn_icon",src:V,onClick:s[5]||(s[5]=e=>l.handleBtnAdd())},null,512),[[C,!i.isFocus&&!i.isEmote]]),E(_(h,{class:"send",onClick:l.send},{default:p((()=>[T("发送")])),_:1},8,["onClick"]),[[C,i.isFocus||i.isEmote]])])),_:1}),E(_(a,{class:"emote_box"},{default:p((()=>[(I(!0),x(y,null,H(i.emoteArr,(e=>(I(),m(a,{class:"emote_box_item",key:e,onClick:s=>l.handleEmote(e)},{default:p((()=>[T(b(e),1)])),_:2},1032,["onClick"])))),128))])),_:1},512),[[C,!i.isFocus&&!i.isAdd&&i.isEmote]]),E(_(a,{class:"more_box"},{default:p((()=>[_(r,{onClick:S(l.chooseImage,["stop"]),src:v},null,8,["onClick"])])),_:1},512),[[C,!i.isFocus&&!i.isEmote&&i.isAdd]])])),_:1},512)):k("",!0)])),_:1})}],["__scopeId","data-v-9cd47808"]]);export{N as default};
